{"version":3,"file":"usePanelVirtualScroll.js","sources":["../../../../components/select/hooks/usePanelVirtualScroll.ts"],"sourcesContent":["import { useEffect, useMemo, MutableRefObject, useCallback, CSSProperties } from 'react';\nimport useVirtualScroll from '../../hooks/useVirtualScroll';\nimport { TdSelectProps } from '../type';\nimport { TScroll, SizeEnum } from '../../common';\n\ninterface PanelVirtualScroll {\n  scroll?: TdSelectProps['scroll'];\n  popupContentRef: MutableRefObject<HTMLDivElement>;\n  options: TdSelectProps['options'];\n  size: SizeEnum;\n}\n\nconst usePanelVirtualScroll = ({ popupContentRef, scroll, options, size }: PanelVirtualScroll) => {\n  const scrollThreshold = scroll?.threshold || 100;\n  const scrollType = scroll?.type;\n\n  const isVirtual = useMemo<boolean>(\n    () => scrollType === 'virtual' && options?.length > scrollThreshold,\n    [scrollType, scrollThreshold, options],\n  );\n\n  const scrollParams = useMemo<TScroll>(() => {\n    const heightMap = {\n      small: 20,\n      medium: 28,\n      large: 36,\n    };\n    const rowHeight = heightMap[size] || 28;\n    return {\n      type: 'virtual',\n      isFixedRowHeight: scroll?.isFixedRowHeight || false,\n      rowHeight: scroll?.rowHeight || rowHeight,\n      bufferSize: scroll?.bufferSize || 20,\n      threshold: scrollThreshold,\n    };\n  }, [scroll, scrollThreshold, size]);\n\n  const {\n    visibleData = null,\n    handleScroll: handleVirtualScroll = null,\n    scrollHeight = null,\n    translateY = null,\n    handleRowMounted = null,\n  } = useVirtualScroll(popupContentRef, {\n    data: options || [],\n    scroll: scrollParams,\n  });\n\n  let lastScrollY = -1;\n\n  const onInnerVirtualScroll = useCallback((e: WheelEvent) => {\n    if (!isVirtual) {\n      return;\n    }\n    const target = e.target as HTMLElement;\n    const top = target.scrollTop;\n    // 排除横向滚动触发的纵向虚拟滚动计算\n    if (Math.abs(lastScrollY - top) > 5) {\n      handleVirtualScroll();\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n      lastScrollY = top;\n    } else {\n      lastScrollY = -1;\n    }\n  }, []);\n\n  // 监听popup滚动 处理虚拟滚动时的virtualData变化\n  useEffect(() => {\n    const popupContentDom = popupContentRef?.current;\n    if (isVirtual) {\n      popupContentDom?.addEventListener?.('scroll', onInnerVirtualScroll);\n    }\n    return () => {\n      // 卸载时取消监听\n      if (isVirtual) {\n        popupContentDom?.removeEventListener?.('scroll', onInnerVirtualScroll);\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isVirtual, onInnerVirtualScroll, popupContentRef.current]);\n\n  const cursorStyle = {\n    position: 'absolute',\n    width: '1px',\n    height: '1px',\n    transition: 'transform 0.2s',\n    transform: `translate(0, ${scrollHeight}px)`,\n    MsTransform: `translate(0, ${scrollHeight}px)`,\n    MozTransform: `translate(0, ${scrollHeight}px)`,\n    WebkitTransform: `translate(0, ${scrollHeight}px)`,\n  } as CSSProperties;\n\n  const panelStyle = {\n    transform: `translate(0, ${translateY}px)`,\n    MsTransform: `translate(0, ${translateY}px)`,\n    MozTransform: `translate(0, ${translateY}px)`,\n    WebkitTransform: `translate(0, ${translateY}px)`,\n  } as CSSProperties;\n\n  return {\n    scrollHeight,\n    translateY,\n    visibleData,\n    handleRowMounted,\n    isVirtual,\n    cursorStyle,\n    panelStyle,\n  };\n};\n\nexport default usePanelVirtualScroll;\n"],"names":["usePanelVirtualScroll","popupContentRef","scroll","_ref","options","size","scrollThreshold","threshold","scrollType","type","isVirtual","useMemo","length","scrollParams","heightMap","small","medium","large","rowHeight","isFixedRowHeight","bufferSize","_useVirtualScroll","useVirtualScroll","data","_useVirtualScroll$vis","visibleData","_useVirtualScroll$han","handleScroll","handleVirtualScroll","_useVirtualScroll$scr","scrollHeight","_useVirtualScroll$tra","translateY","_useVirtualScroll$han2","handleRowMounted","lastScrollY","onInnerVirtualScroll","useCallback","e","target","top","scrollTop","Math","abs","useEffect","popupContentDom","current","_popupContentDom$addE","addEventListener","call","_popupContentDom$remo","removeEventListener","cursorStyle","position","width","height","transition","transform","MsTransform","MozTransform","WebkitTransform","panelStyle"],"mappings":"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"}