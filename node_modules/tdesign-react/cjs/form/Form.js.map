{"version":3,"file":"Form.js","sources":["../../../components/form/Form.tsx"],"sourcesContent":["import React, { useRef, useImperativeHandle } from 'react';\nimport classNames from 'classnames';\nimport useConfig from '../hooks/useConfig';\nimport noop from '../_util/noop';\nimport forwardRefWithStatics from '../_util/forwardRefWithStatics';\nimport type { TdFormProps } from './type';\nimport useInstance from './hooks/useInstance';\nimport useForm, { HOOK_MARK } from './hooks/useForm';\nimport useWatch from './hooks/useWatch';\nimport { StyledProps } from '../common';\nimport FormContext from './FormContext';\nimport FormItem from './FormItem';\nimport FormList from './FormList';\nimport { formDefaultProps } from './defaultProps';\nimport useDefaultProps from '../hooks/useDefaultProps';\n\nexport interface FormProps extends TdFormProps, StyledProps {\n  children?: React.ReactNode;\n}\n\nconst Form = forwardRefWithStatics(\n  (originalProps: FormProps, ref) => {\n    const { classPrefix, form: globalFormConfig } = useConfig();\n    const props = useDefaultProps<FormProps>(originalProps, formDefaultProps);\n    const {\n      style,\n      className,\n      labelWidth,\n      statusIcon,\n      labelAlign,\n      layout,\n      colon,\n      initialData,\n      requiredMark = globalFormConfig.requiredMark,\n      scrollToFirstError,\n      showErrorMessage,\n      resetType,\n      rules,\n      errorMessage = globalFormConfig.errorMessage,\n      preventSubmitDefault,\n      disabled,\n      children,\n      id,\n      onReset,\n      onValuesChange = noop,\n    } = props;\n\n    const formClass = classNames(`${classPrefix}-form`, className, {\n      [`${classPrefix}-form-inline`]: layout === 'inline',\n    });\n\n    const [form] = useForm(props.form); // 内部与外部共享 form 实例，外部不传则内部创建\n    const formRef = useRef<HTMLFormElement>(null);\n    const formMapRef = useRef(new Map()); // 收集所有包含 name 属性 formItem 实例\n    const floatingFormDataRef = useRef({}); // 储存游离值的 formData\n    const formInstance = useInstance(props, formRef, formMapRef, floatingFormDataRef);\n\n    useImperativeHandle(ref, () => formInstance);\n    Object.assign(form, { ...formInstance });\n    form?.getInternalHooks?.(HOOK_MARK)?.setForm?.(formInstance);\n\n    // form 初始化后清空队列\n    React.useEffect(() => {\n      form?.getInternalHooks?.(HOOK_MARK)?.flashQueue?.();\n    }, [form]);\n\n    function onResetHandler(e: React.FormEvent<HTMLFormElement>) {\n      [...formMapRef.current.values()].forEach((formItemRef) => {\n        formItemRef?.current.resetField();\n      });\n      form?.getInternalHooks?.(HOOK_MARK)?.notifyWatch?.([]);\n      onReset?.({ e });\n    }\n\n    function onFormItemValueChange(changedValue: Record<string, unknown>) {\n      const allFields = formInstance.getFieldsValue(true);\n      onValuesChange(changedValue, allFields);\n    }\n\n    function onKeyDownHandler(e: React.KeyboardEvent<HTMLFormElement>) {\n      // 禁用 input 输入框回车自动提交 form\n      if ((e.target as Element).tagName.toLowerCase() !== 'input') return;\n      if (preventSubmitDefault && e.key === 'Enter') {\n        e.preventDefault?.();\n        e.stopPropagation?.();\n      }\n    }\n\n    return (\n      <FormContext.Provider\n        value={{\n          form,\n          labelWidth,\n          statusIcon,\n          labelAlign,\n          layout,\n          colon,\n          initialData,\n          requiredMark,\n          errorMessage,\n          showErrorMessage,\n          scrollToFirstError,\n          resetType,\n          rules,\n          disabled,\n          formMapRef,\n          floatingFormDataRef,\n          onFormItemValueChange,\n        }}\n      >\n        <form\n          ref={formRef}\n          id={id}\n          style={style}\n          className={formClass}\n          onSubmit={formInstance.submit}\n          onReset={onResetHandler}\n          onKeyDown={onKeyDownHandler}\n        >\n          {children}\n        </form>\n      </FormContext.Provider>\n    );\n  },\n  { useForm, useWatch, FormItem, FormList },\n);\n\nForm.displayName = 'Form';\n\nexport default Form;\n"],"names":["Form","forwardRefWithStatics","originalProps","ref","_form$getInternalHook","_form$getInternalHook2","_useConfig","useConfig","classPrefix","globalFormConfig","form","props","useDefaultProps","formDefaultProps","style","className","labelWidth","statusIcon","labelAlign","layout","colon","initialData","_props$requiredMark","requiredMark","scrollToFirstError","showErrorMessage","resetType","rules","_props$errorMessage","errorMessage","preventSubmitDefault","disabled","children","id","onReset","_props$onValuesChange","onValuesChange","noop","formClass","classNames","concat","_defineProperty","_useForm","useForm","_useForm2","_slicedToArray","formRef","useRef","formMapRef","Map","floatingFormDataRef","formInstance","useInstance","useImperativeHandle","Object","assign","_objectSpread","getInternalHooks","call","HOOK_MARK","setForm","React","useEffect","_form$getInternalHook3","_form$getInternalHook4","flashQueue","onResetHandler","e","_form$getInternalHook5","_form$getInternalHook6","_toConsumableArray","current","values","forEach","formItemRef","resetField","notifyWatch","onFormItemValueChange","changedValue","allFields","getFieldsValue","onKeyDownHandler","target","tagName","toLowerCase","key","_e$preventDefault","_e$stopPropagation","preventDefault","stopPropagation","createElement","FormContext","Provider","value","onSubmit","submit","onKeyDown","useWatch","FormItem","FormList","displayName"],"mappings":"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"}