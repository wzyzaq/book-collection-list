{"version":3,"file":"FormList.js","sources":["../../../components/form/FormList.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useImperativeHandle } from 'react';\nimport { merge, get } from 'lodash-es';\nimport log from '@tdesign/common-js/log/index';\nimport { FormListContext, useFormContext } from './FormContext';\nimport { FormItemInstance } from './FormItem';\nimport { HOOK_MARK } from './hooks/useForm';\nimport { TdFormListProps, FormListFieldOperation, FormListField } from './type';\nimport { calcFieldValue } from './utils';\n\nlet key = 0;\n\nconst FormList: React.FC<TdFormListProps> = (props) => {\n  const {\n    formMapRef,\n    form,\n    onFormItemValueChange,\n    initialData: initialDataFromForm,\n    resetType: resetTypeFromContext,\n  } = useFormContext();\n  const { name, rules, children } = props;\n\n  const initialData = props.initialData || get(initialDataFromForm, name) || [];\n\n  const [formListValue, setFormListValue] = useState(initialData);\n  const [fields, setFields] = useState<Array<FormListField>>(() =>\n    initialData.map((data, index) => ({\n      data: { ...data },\n      key: (key += 1),\n      name: index,\n      isListField: true,\n    })),\n  );\n  const formListMapRef = useRef(new Map()); // 收集 formItem 实例\n  const formListRef = useRef<FormItemInstance>(null); // 当前 formList 实例\n  const fieldsTaskQueueRef = useRef([]); // 记录更改 fields 数据后 callback 队列\n  const snakeName = []\n    .concat(name)\n    .filter((item) => item !== undefined)\n    .toString(); // 转化 name\n\n  const isMounted = useRef(false);\n\n  useEffect(\n    () => () => {\n      isMounted.current = false;\n    },\n    [],\n  );\n\n  const operation: FormListFieldOperation = {\n    add(defaultValue?: any, insertIndex?: number) {\n      const cloneFields = [...fields];\n      const index = insertIndex ?? cloneFields.length;\n      cloneFields.splice(index, 0, {\n        key: (key += 1),\n        name: index,\n        isListField: true,\n      });\n      cloneFields.forEach((field, index) => Object.assign(field, { name: index }));\n      setFields(cloneFields);\n\n      const nextFormListValue = [...formListValue];\n      if (typeof defaultValue !== 'undefined') {\n        nextFormListValue[index] = defaultValue;\n        setFormListValue(nextFormListValue);\n      }\n      const fieldValue = calcFieldValue(name, nextFormListValue);\n      requestAnimationFrame(() => {\n        onFormItemValueChange?.({ ...fieldValue });\n      });\n    },\n    remove(index: number | number[]) {\n      const nextFields = fields\n        .filter((item) => {\n          if (Array.isArray(index)) return !index.includes(item.name);\n          return item.name !== index;\n        })\n        .map((field, i) => ({ ...field, name: i }));\n      setFields(nextFields);\n\n      const nextFormListValue = formListValue.filter((_, idx) => idx !== index);\n      setFormListValue(nextFormListValue);\n\n      const fieldValue = calcFieldValue(name, nextFormListValue);\n      requestAnimationFrame(() => {\n        onFormItemValueChange?.({ ...fieldValue });\n      });\n    },\n    move(from: number, to: number) {\n      const cloneFields = [...fields];\n      const fromItem = { ...cloneFields[from] };\n      const toItem = { ...cloneFields[to] };\n      cloneFields[to] = fromItem;\n      cloneFields[from] = toItem;\n      setFields(cloneFields);\n    },\n  };\n\n  // 外部设置 fields 优先级最高，可以更改渲染的节点\n  function setListFields(fieldData: any[], callback: Function, originData) {\n    setFields(\n      fieldData.map((_, index) => ({\n        key: (key += 1),\n        name: index,\n        isListField: true,\n      })),\n    );\n    // 添加至队列中 等待下次渲染完成执行对应逻辑\n    fieldsTaskQueueRef.current.push({ callback, fieldData, originData });\n  }\n\n  useEffect(() => {\n    if (!name || !formMapRef) return;\n    formMapRef.current.set(name, formListRef);\n\n    return () => {\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n      formMapRef.current.delete(name);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [snakeName]);\n\n  useEffect(() => {\n    [...formListMapRef.current.values()].forEach((formItemRef) => {\n      if (!formItemRef.current) return;\n\n      const { name, isUpdated } = formItemRef.current;\n      if (isUpdated) return; // 内部更新过值则跳过\n\n      const data = get(formListValue, name);\n      formItemRef.current.setField({ value: data, status: 'not' });\n    });\n  }, [formListValue]);\n\n  useEffect(() => {\n    if (!isMounted.current) {\n      isMounted.current = true;\n      return;\n    }\n    // fields 变化通知 watch 事件\n    form?.getInternalHooks?.(HOOK_MARK)?.notifyWatch?.(name);\n\n    // 等待子节点渲染完毕\n    Promise.resolve().then(() => {\n      if (!fieldsTaskQueueRef.current.length) return;\n\n      // fix multiple formlist stuck\n      const currentQueue = fieldsTaskQueueRef.current.pop();\n      const { fieldData, callback, originData } = currentQueue;\n\n      [...formListMapRef.current.values()].forEach((formItemRef) => {\n        if (!formItemRef.current) return;\n\n        const { name: itemName } = formItemRef.current;\n        const data = get(fieldData, itemName);\n        callback(formItemRef, data);\n      });\n\n      // formList 嵌套 formList\n      if (!formMapRef || !formMapRef.current) return;\n      [...formMapRef.current.values()].forEach((formItemRef) => {\n        if (!formItemRef.current) return;\n\n        const { name: itemName, isFormList } = formItemRef.current;\n        if (String(itemName) === String(name) || !isFormList) return;\n        const data = get(originData, itemName);\n        if (data) callback(formItemRef, data);\n      });\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [form, snakeName, fields, formMapRef]);\n\n  useImperativeHandle(\n    formListRef,\n    (): FormItemInstance => ({\n      name,\n      isFormList: true,\n      getValue() {\n        const formListValue = [];\n        [...formListMapRef.current.values()].forEach((formItemRef) => {\n          if (!formItemRef.current) return;\n\n          const { name, getValue } = formItemRef.current;\n          const fieldValue = calcFieldValue(name, getValue());\n          merge(formListValue, fieldValue);\n        });\n        return formListValue;\n      },\n      validate: (trigger = 'all') => {\n        const resultList = [];\n        const validates = [...formListMapRef.current.values()].map((formItemRef) =>\n          formItemRef?.current?.validate?.(trigger),\n        );\n        return new Promise((resolve) => {\n          Promise.all(validates).then((validateResult) => {\n            validateResult.forEach((result) => {\n              const errorValue = Object.values(result)[0];\n              merge(resultList, errorValue);\n            });\n            const errorItems = validateResult.filter((item) => Object.values(item)[0] !== true);\n            if (errorItems.length) {\n              resolve({ [snakeName]: resultList });\n            } else {\n              resolve({ [snakeName]: true });\n            }\n          });\n        });\n      },\n      // TODO 支持局部更新数据\n      setValue: (fieldData: any[], originData) => {\n        setListFields(\n          fieldData,\n          (formItemRef, data) => {\n            formItemRef?.current?.setValue?.(data);\n          },\n          originData,\n        );\n      },\n      setField: (fieldData: { value?: any[]; status?: string }, originData) => {\n        const { value, status } = fieldData;\n        setListFields(\n          value,\n          (formItemRef, data) => {\n            formItemRef?.current?.setField?.({ value: data, status });\n          },\n          originData,\n        );\n      },\n      resetField: (type: string) => {\n        const resetType = type || resetTypeFromContext;\n        [...formListMapRef.current.values()].forEach((formItemRef) => {\n          formItemRef?.current?.resetField?.();\n        });\n        setFormListValue([]);\n        fieldsTaskQueueRef.current = [];\n        key = 0;\n        if (resetType === 'initial') {\n          setFields(\n            initialData.map((data, index) => ({\n              data: { ...data },\n              key: (key += 1),\n              name: index,\n              isListField: true,\n            })),\n          );\n        } else {\n          setFields([]);\n        }\n      },\n      setValidateMessage: (fieldData) => {\n        [...formListMapRef.current.values()].forEach((formItemRef) => {\n          if (!formItemRef.current) return;\n\n          const { name } = formItemRef.current;\n          const data = get(fieldData, name);\n\n          formItemRef?.current?.setValidateMessage?.(data);\n        });\n      },\n      resetValidate: () => {\n        [...formListMapRef.current.values()].forEach((formItemRef) => {\n          formItemRef?.current?.resetValidate?.();\n        });\n      },\n    }),\n  );\n\n  if (typeof children !== 'function') {\n    log.error('Form', `FormList's children must be a function!`);\n    return null;\n  }\n\n  return (\n    <FormListContext.Provider value={{ name, rules, formListMapRef, initialData }}>\n      {children(fields, operation)}\n    </FormListContext.Provider>\n  );\n};\n\nFormList.displayName = 'FormList';\n\nexport default FormList;\n"],"names":["key","FormList","props","_useFormContext","useFormContext","formMapRef","form","onFormItemValueChange","initialDataFromForm","initialData","resetTypeFromContext","resetType","name","rules","children","get","_useState","useState","_useState2","_slicedToArray","formListValue","setFormListValue","_useState3","map","data","index","_objectSpread","isListField","_useState4","fields","setFields","formListMapRef","useRef","Map","formListRef","fieldsTaskQueueRef","snakeName","concat","filter","item","toString","isMounted","useEffect","current","operation","add","defaultValue","insertIndex","cloneFields","_toConsumableArray","length","splice","forEach","field","Object","assign","nextFormListValue","fieldValue","calcFieldValue","requestAnimationFrame","remove","nextFields","Array","isArray","includes","i","_","idx","move","from","to","fromItem","toItem","setListFields","fieldData","callback","originData","push","set","values","formItemRef","_formItemRef$current","isUpdated","setField","value","status","_form$getInternalHook","_form$getInternalHook2","getInternalHooks","call","HOOK_MARK","notifyWatch","Promise","resolve","then","currentQueue","pop","itemName","_formItemRef$current2","isFormList","String","useImperativeHandle","getValue","_formItemRef$current3","merge","validate","trigger","arguments","undefined","resultList","validates","_formItemRef$current4","_formItemRef$current5","all","validateResult","result","errorValue","errorItems","_defineProperty","setValue","_formItemRef$current6","_formItemRef$current7","_formItemRef$current8","_formItemRef$current9","resetField","type","_formItemRef$current10","_formItemRef$current11","setValidateMessage","_formItemRef$current12","_formItemRef$current13","resetValidate","_formItemRef$current14","_formItemRef$current15","log","error","React","createElement","FormListContext","Provider","displayName"],"mappings":"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"}