{"version":3,"file":"useDraggable.js","sources":["../../../../components/tree/hooks/useDraggable.tsx"],"sourcesContent":["import { throttle } from 'lodash-es';\nimport { RefObject, DragEvent, useState, useRef } from 'react';\nimport { TreeNode } from '@tdesign/common-js/tree-v1/tree-node';\nimport { useTreeDraggableContext } from './TreeDraggableContext';\nimport { DropPosition } from '../interface';\nimport { usePersistFn } from '../../hooks/usePersistFn';\n\nimport type { TdTreeProps } from '../type';\n\nexport default function useDraggable(props: {\n  nodeRef: RefObject<HTMLElement | undefined>;\n  node: TreeNode;\n  allowDrop?: TdTreeProps['allowDrop'];\n}) {\n  const { nodeRef, node, allowDrop } = props;\n  const { onDragStart, onDragEnd, onDragLeave, onDragOver, onDrop } = useTreeDraggableContext();\n\n  const [state, setState] = useState<{\n    isDragOver: boolean;\n    isDragging: boolean;\n    dropPosition: DropPosition;\n  }>({\n    isDragOver: false,\n    isDragging: false,\n    dropPosition: 0,\n  });\n\n  const setPartialState = usePersistFn((newState: Partial<typeof state>) => {\n    setState((prev) => ({\n      ...prev,\n      ...newState,\n    }));\n  });\n\n  const updateDropPosition = useRef(\n    throttle((e: DragEvent) => {\n      if (!nodeRef.current) return;\n\n      const rect = nodeRef.current.getBoundingClientRect();\n      const offsetY = window.pageYOffset + rect.top;\n      const { pageY } = e;\n      const gapHeight = rect.height / 4;\n      const diff = pageY - offsetY;\n\n      if (diff < gapHeight) {\n        setPartialState({ dropPosition: -1 });\n      } else if (diff < rect.height - gapHeight) {\n        setPartialState({ dropPosition: 0 });\n      } else {\n        setPartialState({ dropPosition: 1 });\n      }\n    }),\n  ).current;\n\n  const setDragStatus = (\n    status: 'dragStart' | 'dragOver' | 'dragLeave' | 'dragEnd' | 'drop',\n    e: DragEvent<HTMLDivElement>,\n  ) => {\n    switch (status) {\n      case 'dragStart':\n        setPartialState({\n          isDragging: true,\n          dropPosition: 0,\n        });\n        onDragStart?.({ node, e });\n        break;\n      case 'dragEnd':\n        setPartialState({\n          isDragging: false,\n          isDragOver: false,\n          dropPosition: 0,\n        });\n        updateDropPosition.cancel();\n        onDragEnd?.({ node, e });\n        break;\n      case 'dragOver':\n        setPartialState({\n          isDragOver: true,\n        });\n        updateDropPosition(e);\n        onDragOver?.({ node, e });\n        break;\n      case 'dragLeave':\n        setPartialState({\n          isDragOver: false,\n          dropPosition: 0,\n        });\n        updateDropPosition.cancel();\n        onDragLeave?.({ node, e });\n        break;\n      case 'drop':\n        onDrop?.({ node, dropPosition: state.dropPosition, e, allowDrop });\n        setPartialState({\n          isDragOver: false,\n        });\n        updateDropPosition.cancel();\n        break;\n      default:\n        break;\n    }\n  };\n\n  return {\n    ...state,\n    setDragStatus,\n  };\n}\n"],"names":["useDraggable","props","nodeRef","node","allowDrop","_useTreeDraggableCont","useTreeDraggableContext","onDragStart","onDragEnd","onDragLeave","onDragOver","onDrop","_useState","useState","isDragOver","isDragging","dropPosition","_useState2","_slicedToArray","state","setState","setPartialState","usePersistFn","newState","prev","_objectSpread","updateDropPosition","useRef","throttle","e","current","rect","getBoundingClientRect","offsetY","window","pageYOffset","top","pageY","gapHeight","height","diff","setDragStatus","status","cancel"],"mappings":"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"}