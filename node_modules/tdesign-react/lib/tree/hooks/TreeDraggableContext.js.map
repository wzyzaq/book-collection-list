{"version":3,"file":"TreeDraggableContext.js","sources":["../../../../components/tree/hooks/TreeDraggableContext.tsx"],"sourcesContent":["import { useRef, DragEvent } from 'react';\nimport TreeStore from '@tdesign/common-js/tree-v1/tree-store';\nimport TreeNode from '@tdesign/common-js/tree-v1/tree-node';\nimport { TreeProps } from '../Tree';\nimport { createHookContext } from '../../_util/createHookContext';\n\nimport type { TdTreeProps } from '../type';\n\ninterface Value {\n  props: TreeProps;\n  store: TreeStore;\n}\n\nexport const TreeDraggableContext = createHookContext((value: Value) => {\n  const { props, store } = value;\n\n  const dragNode = useRef<TreeNode | null>(null);\n\n  const onDragStart = (context: { node: TreeNode; e: DragEvent<HTMLDivElement> }) => {\n    dragNode.current = context.node;\n    props.onDragStart?.({\n      ...context,\n      node: context.node.model,\n    });\n  };\n\n  const onDragEnd = (context: { node: TreeNode; e: DragEvent<HTMLDivElement> }) => {\n    dragNode.current = context.node;\n    props.onDragEnd?.({\n      ...context,\n      node: context.node.model,\n    });\n  };\n\n  const onDragOver = (context: { node: TreeNode; e: DragEvent<HTMLDivElement> }) => {\n    props.onDragOver?.({\n      ...context,\n      node: context.node.model,\n    });\n  };\n\n  const onDragLeave = (context: { node: TreeNode; e: DragEvent<HTMLDivElement> }) => {\n    props.onDragLeave?.({\n      ...context,\n      node: context.node.model,\n    });\n  };\n\n  const onDrop = (context: {\n    node: TreeNode;\n    dropPosition: number;\n    e: DragEvent<HTMLDivElement>;\n    allowDrop?: TdTreeProps['allowDrop'];\n  }) => {\n    const { node, dropPosition } = context;\n    if (\n      node.value === dragNode.current?.value ||\n      node.getParents().some((_node) => _node.value === dragNode.current?.value)\n    ) {\n      return;\n    }\n    const ctx = {\n      dropNode: node.getModel(),\n      dragNode: dragNode.current.getModel(),\n      dropPosition,\n      e: context.e,\n    };\n\n    if (props.allowDrop?.(ctx) === false) return;\n\n    const nodes = store.getNodes() as TreeNode[];\n    nodes.some((_node) => {\n      if (_node.value === node.value) {\n        if (dropPosition === 0) {\n          dragNode.current?.appendTo(store, _node);\n        } else if (dropPosition < 0) {\n          node.insertBefore(dragNode.current);\n        } else {\n          node.insertAfter(dragNode.current);\n        }\n        return true;\n      }\n      return false;\n    });\n    props.onDrop?.({\n      ...context,\n      dragNode: dragNode.current?.model,\n      dropNode: node.model,\n    });\n  };\n\n  return {\n    onDragStart,\n    onDragEnd,\n    onDragOver,\n    onDragLeave,\n    onDrop,\n  };\n});\n\nexport const useTreeDraggableContext = () => TreeDraggableContext.use();\n"],"names":["TreeDraggableContext","createHookContext","value","props","store","dragNode","useRef","onDragStart","context","_props$onDragStart","current","node","call","_objectSpread","model","onDragEnd","_props$onDragEnd","onDragOver","_props$onDragOver","onDragLeave","_props$onDragLeave","onDrop","_dragNode$current","_props$allowDrop","_props$onDrop","_dragNode$current4","dropPosition","getParents","some","_node","_dragNode$current2","ctx","dropNode","getModel","e","allowDrop","nodes","getNodes","_dragNode$current3","appendTo","insertBefore","insertAfter","useTreeDraggableContext","use"],"mappings":"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"}